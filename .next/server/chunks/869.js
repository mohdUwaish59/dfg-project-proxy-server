"use strict";exports.id=869,exports.ids=[869],exports.modules={6249:(t,e)=>{Object.defineProperty(e,"l",{enumerable:!0,get:function(){return function t(e,i){return i in e?e[i]:"then"in e&&"function"==typeof e.then?e.then(e=>t(e,i)):"function"==typeof e&&"default"===i?e:void 0}}})},5410:(t,e,i)=>{let{MongoClient:n,ServerApiVersion:r}=i(8013),a=null,o=null,s=!1;async function c(){if(s&&o)return o;if(!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is required");try{return a=new n(process.env.DATABASE_URL,{serverApi:{version:r.v1,strict:!0,deprecationErrors:!0}}),await a.connect(),o=a.db("otree_proxy"),s=!0,await a.db("admin").command({ping:1}),await l(),o}catch(t){throw console.error("❌ MongoDB connection failed:",t),t}}async function l(){try{await o.collection("admins").createIndex({username:1},{unique:!0}),await o.collection("proxy_links").createIndex({proxy_id:1},{unique:!0}),await o.collection("link_usage").createIndex({proxy_id:1,user_fingerprint:1},{unique:!0})}catch(t){console.log("ℹ️ MongoDB indexes may already exist:",t.message)}}async function u(t){let e=await c();return await e.collection("admins").findOne({username:t})}async function _(t,e){let i=await c();return await i.collection("admins").findOne({username:t,password:e})}async function p(){let t=await c();return await t.collection("admins").find({}).toArray()}async function d(t,e){let i=await c();return await i.collection("admins").insertOne({username:t,password:e,created_at:new Date})}async function y(){let t=await c();return(await t.collection("proxy_links").find({}).sort({created_at:-1}).toArray()).map((t,e)=>({id:t._id?t._id.toString():e+1,proxy_id:t.proxy_id,real_url:t.real_url,group_name:t.group_name,otree_session_id:t.otree_session_id||null,category:t.category||null,treatment_title:t.treatment_title||null,post_experiment_redirect_url:t.post_experiment_redirect_url||null,max_uses:t.max_uses||3,current_uses:t.current_uses||0,is_active:!1!==t.is_active,status:t.status||"active",completed_at:t.completed_at,created_at:t.created_at instanceof Date?t.created_at.toISOString():t.created_at||new Date().toISOString(),created_by:t.created_by||"admin"}))}async function f(t){let e=await c();return await e.collection("proxy_links").findOne({proxy_id:t})}async function g(t){let e=await c();return await e.collection("proxy_links").findOne({proxy_id:t,is_active:{$ne:!1}})}async function w(t,e,i,n=200,r=null,a=null,o=null,s=null){let l=await c();return await l.collection("proxy_links").insertOne({proxy_id:t,real_url:e,group_name:i,otree_session_id:s,category:r,treatment_title:a,post_experiment_redirect_url:o,max_uses:n,group_size:3,current_uses:0,groups_formed:0,is_active:!0,created_at:new Date,created_by:"admin"})}async function x(t,e){let i=await c();return await i.collection("proxy_links").updateOne({proxy_id:t},{$set:{is_active:e}})}async function m(t){let e=await c();return await e.collection("proxy_links").updateOne({proxy_id:t},{$inc:{current_uses:1}})}async function A(t){let e=await c();return await e.collection("proxy_links").updateOne({proxy_id:t},{$set:{current_uses:0}}),await e.collection("link_usage").deleteMany({proxy_id:t})}async function k(t,e){let i=await c();return await i.collection("proxy_links").updateOne({proxy_id:t},{$set:{post_experiment_redirect_url:e}})}async function O(t){let e=await c();return await e.collection("link_usage").deleteMany({proxy_id:t}),await e.collection("proxy_links").deleteOne({proxy_id:t})}async function h(t,e){let i=await c();return await i.collection("link_usage").findOne({proxy_id:t,user_fingerprint:e})}async function M(t,e,i,n,r,a=null,o=null){let s=await c(),l=new Date;return await s.collection("link_usage").insertOne({proxy_id:t,session_id:e,user_ip:i,user_fingerprint:n,participant_number:r,gender:a,prolific_pid:o,status:"waiting",group_session_id:null,joined_at:l,participant_timer_start:l,participant_timer_expired:!1,redirected_at:null,used_at:new Date})}async function b(t){let e=await c();return await P(t),await e.collection("link_usage").find({proxy_id:t,status:"waiting"}).sort({joined_at:1}).toArray()}async function E(t,e){let i=await c();return await P(t),await i.collection("link_usage").find({proxy_id:t,status:"waiting",gender:e}).sort({joined_at:1}).toArray()}async function P(t){let e=await c(),i=new Date(new Date().getTime()-6e5);return(await e.collection("link_usage").updateMany({proxy_id:t,status:"waiting",participant_timer_start:{$lte:i},participant_timer_expired:!1},{$set:{status:"expired",participant_timer_expired:!0}})).modifiedCount}async function S(t){let e=await c(),i=await e.collection("link_usage").findOne({proxy_id:t,status:"redirected",group_type:{$exists:!0}},{sort:{redirected_at:-1}});return i?.group_type||"1M_2F"}async function v(t){let e=await c();return await e.collection("link_usage").find({proxy_id:t}).sort({joined_at:1}).toArray()}async function D(t,e,i,n=null){let r=await c(),a={status:i,..."redirected"===i&&{redirected_at:new Date},...n&&{group_session_id:n}};return await r.collection("link_usage").updateOne({proxy_id:t,user_fingerprint:e},{$set:a})}async function F(t,e,n=null){let r=await c(),a=i(6113).randomBytes(16).toString("hex"),o={group_session_id:a,status:"redirected",redirected_at:new Date};return n&&(o.group_type=n),await r.collection("link_usage").updateMany({proxy_id:t,user_fingerprint:{$in:e}},{$set:o}),await r.collection("proxy_links").updateOne({proxy_id:t},{$inc:{groups_formed:1,current_uses:e.length}}),a}async function $(t,e,i){if(await c(),!e||"No Gender"===e){let e=await b(t),n=e.length>=i;return{canForm:n,participants:n?e.slice(0,i):[]}}if("All Male"===e){let e=await E(t,"MALE"),n=e.length>=i;return{canForm:n,participants:n?e.slice(0,i):[]}}if("All Female"===e){let e=await E(t,"FEMALE"),n=e.length>=i;return{canForm:n,participants:n?e.slice(0,i):[]}}if("Mixed"===e){let e;let i=await E(t,"MALE"),n=await E(t,"FEMALE"),r=i.length,a=n.length,o=r>=2&&a>=1,s=r>=1&&a>=2;if(!o&&!s)return{canForm:!1,participants:[],groupType:null};let c=[];return o&&s?r>=2*a?(e="2M_1F",c=[i[0],i[1],n[0]]):a>=2*r?(e="1M_2F",c=[i[0],n[0],n[1]]):"2M_1F"===await S(t)?(e="1M_2F",c=[i[0],n[0],n[1]]):(e="2M_1F",c=[i[0],i[1],n[0]]):o?(e="2M_1F",c=[i[0],i[1],n[0]]):(e="1M_2F",c=[i[0],n[0],n[1]]),{canForm:!0,participants:c,groupType:e}}return{canForm:!1,participants:[]}}async function T(t){let e=await c(),i=await e.collection("proxy_links").findOne({proxy_id:t});if(!i)return null;let n=await b(t),r=await e.collection("link_usage").find({proxy_id:t}).toArray(),a=r.filter(t=>"redirected"===t.status),o=r.filter(t=>"expired"===t.status),s=r.length,l=s>=i.max_uses,u=a.length>0;return{proxy_id:t,group_name:i.group_name,category:i.category,treatment_title:i.treatment_title,max_uses:i.max_uses,current_waiting:n.length,total_joined:s,is_full:l,has_redirected_group:u,waiting_participants:n.map(t=>({participant_number:t.participant_number,joined_at:t.joined_at,fingerprint:t.user_fingerprint.substring(0,8)+"..."})),redirected_participants:a.map(t=>({participant_number:t.participant_number,redirected_at:t.redirected_at,group_session_id:t.group_session_id})),expired_participants:o.map(t=>({participant_number:t.participant_number,joined_at:t.joined_at,fingerprint:t.user_fingerprint.substring(0,8)+"..."})),real_url:i.real_url}}async function j(t,e){let i=await c(),n=await i.collection("link_usage").findOne({proxy_id:t,user_fingerprint:e});if(!n||!n.participant_timer_start)return{expired:!1,timeLeft:600,timerStart:null};if("redirected"===n.status)return{expired:!1,timeLeft:0,timerStart:n.participant_timer_start.getTime(),isRedirected:!0};if(n.participant_timer_expired||"expired"===n.status)return{expired:!0,timeLeft:0,timerStart:n.participant_timer_start.getTime()};let r=Math.max(0,600-Math.floor((new Date-n.participant_timer_start)/1e3));return r<=0?(await i.collection("link_usage").updateOne({proxy_id:t,user_fingerprint:e},{$set:{participant_timer_expired:!0,status:"expired"}}),{expired:!0,timeLeft:0,timerStart:n.participant_timer_start.getTime()}):{expired:!1,timeLeft:r,timerStart:n.participant_timer_start.getTime()}}async function L(t,e){let i=await c();return await i.collection("link_usage").updateOne({proxy_id:t,user_fingerprint:e},{$set:{participant_timer_expired:!0,status:"expired"}})}async function G(){let t=await c(),e=await t.collection("proxy_links").find({}).toArray(),i=e.length,n=e.filter(t=>!1!==t.is_active&&"used"!==t.status&&"expired"!==t.status).length,r=e.reduce((t,e)=>t+(e.current_uses||0),0);return{total:i,active:n,participants:r,full:e.filter(t=>(t.current_uses||0)>=(t.max_uses||3)).length,used:e.filter(t=>"used"===t.status).length,expired:e.filter(t=>"expired"===t.status).length}}t.exports={connectToDatabase:c,findAdmin:u,findAdminWithPassword:_,getAllAdmins:p,createAdmin:d,getAllProxyLinks:y,getProxyLink:f,getActiveProxyLink:g,createProxyLink:w,updateProxyLinkStatus:x,incrementProxyLinkUsage:m,resetProxyLinkUsage:A,updatePostExperimentRedirectUrl:k,deleteProxyLink:O,checkLinkUsage:h,recordLinkUsage:M,getProxyStats:G,getWaitingParticipants:b,getWaitingParticipantsByGender:E,updateParticipantStatus:D,createGroupSession:F,getGroupStatus:T,canFormGenderBasedGroup:$,getAllParticipants:v,checkParticipantExpiration:j,expireParticipant:L,expireTimedOutParticipants:P,getLastMixedGroupType:S}},7153:(t,e)=>{var i;Object.defineProperty(e,"x",{enumerable:!0,get:function(){return i}}),function(t){t.PAGES="PAGES",t.PAGES_API="PAGES_API",t.APP_PAGE="APP_PAGE",t.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(t,e,i)=>{t.exports=i(145)}};
"use strict";(()=>{var e={};e.id=273,e.ids=[273],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},6791:(e,t,n)=>{n.r(t),n.d(t,{config:()=>f,default:()=>y,routeModule:()=>w});var r={};n.r(r),n.d(r,{default:()=>g});var i=n(1802),a=n(7153),o=n(6249);let{getActiveProxyLink:s,checkLinkUsage:u,recordLinkUsage:c,getWaitingParticipants:l,createGroupSession:d}=n(5410),{logActivity:_,getClientIP:p}=n(4090);async function g(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let{id:n}=e.query,{fingerprint:r}=e.body;if(!r)return t.status(400).json({error:"Fingerprint is required"});try{let i=await s(n);if(!i)return t.status(404).json({error:"Link not found or inactive",canJoin:!1});let a=await u(n,r);if(a)return t.json({canJoin:!0,alreadyJoined:!0,status:a.status,participantNumber:a.participant_number,groupSessionId:a.group_session_id});let o=await l(n);if(o.length>=i.max_uses)return t.status(403).json({error:"This experiment is full. No more participants can join.",canJoin:!1});let g=o.length+1;await c(n,e.headers["x-vercel-id"]||"unknown",p(e),r,g),_("Participant joined waiting room",{proxyId:n,participantNumber:g,fingerprint:r.substring(0,8)+"..."});let y=await l(n),f=y.length>=i.max_uses;console.log("Group status check:",{proxyId:n,waitingCount:y.length,maxUses:i.max_uses,isGroupComplete:f});let w=null;if(f){let e=y.map(e=>e.user_fingerprint);w=await d(n,e),console.log("Group completed! Created session:",w),_("Group completed - ready for redirect",{proxyId:n,groupSessionId:w,participantCount:y.length})}return t.json({canJoin:!0,alreadyJoined:!1,status:f?"redirected":"waiting",participantNumber:g,currentWaiting:f?i.max_uses:y.length,maxParticipants:i.max_uses,isGroupComplete:f,groupSessionId:w,redirectUrl:f?i.real_url:null})}catch(e){return console.error("❌ Join waiting room error:",e),_("Join waiting room error",{error:e.message,proxyId:n}),t.status(500).json({error:"Internal server error"})}}let y=(0,o.l)(r,"default"),f=(0,o.l)(r,"config"),w=new i.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/proxy/[id]/join",pathname:"/api/proxy/[id]/join",bundlePath:"",filename:""},userland:r})},5410:(e,t,n)=>{let{MongoClient:r,ServerApiVersion:i}=n(8013),a=null,o=null,s=!1;async function u(){if(s&&o)return o;if(!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is required");try{return console.log("\uD83D\uDD0D Connecting to MongoDB..."),a=new r(process.env.DATABASE_URL,{serverApi:{version:i.v1,strict:!0,deprecationErrors:!0}}),await a.connect(),o=a.db("otree_proxy"),s=!0,await a.db("admin").command({ping:1}),console.log("✅ MongoDB connected successfully"),await c(),o}catch(e){throw console.error("❌ MongoDB connection failed:",e),e}}async function c(){try{await o.collection("admins").createIndex({username:1},{unique:!0}),await o.collection("proxy_links").createIndex({proxy_id:1},{unique:!0}),await o.collection("link_usage").createIndex({proxy_id:1,user_fingerprint:1},{unique:!0}),console.log("✅ MongoDB indexes created")}catch(e){console.log("ℹ️ MongoDB indexes may already exist:",e.message)}}async function l(e){let t=await u();return await t.collection("admins").findOne({username:e})}async function d(e,t){let n=await u();return await n.collection("admins").findOne({username:e,password:t})}async function _(){let e=await u();return await e.collection("admins").find({}).toArray()}async function p(e,t){let n=await u();return await n.collection("admins").insertOne({username:e,password:t,created_at:new Date})}async function g(){let e=await u();return(await e.collection("proxy_links").find({}).sort({created_at:-1}).toArray()).map((e,t)=>({id:e._id?e._id.toString():t+1,proxy_id:e.proxy_id,real_url:e.real_url,group_name:e.group_name,category:e.category||null,treatment_title:e.treatment_title||null,max_uses:e.max_uses||3,current_uses:e.current_uses||0,is_active:!1!==e.is_active,status:e.status||"active",completed_at:e.completed_at,created_at:e.created_at instanceof Date?e.created_at.toISOString():e.created_at||new Date().toISOString(),created_by:e.created_by||"admin"}))}async function y(e){let t=await u();return await t.collection("proxy_links").findOne({proxy_id:e})}async function f(e){let t=await u();return await t.collection("proxy_links").findOne({proxy_id:e,is_active:{$ne:!1}})}async function w(e,t,n,r=3,i=null,a=null){let o=await u();return await o.collection("proxy_links").insertOne({proxy_id:e,real_url:t,group_name:n,category:i,treatment_title:a,max_uses:r,current_uses:0,is_active:!0,created_at:new Date,created_by:"admin"})}async function m(e,t){let n=await u();return await n.collection("proxy_links").updateOne({proxy_id:e},{$set:{is_active:t}})}async function x(e){let t=await u();return await t.collection("proxy_links").updateOne({proxy_id:e},{$inc:{current_uses:1}})}async function h(e){let t=await u();return await t.collection("proxy_links").updateOne({proxy_id:e},{$set:{current_uses:0}}),await t.collection("link_usage").deleteMany({proxy_id:e})}async function A(e){let t=await u();return await t.collection("link_usage").deleteMany({proxy_id:e}),await t.collection("proxy_links").deleteOne({proxy_id:e})}async function P(e,t){let n=await u();return await n.collection("link_usage").findOne({proxy_id:e,user_fingerprint:t})}async function k(e,t,n,r,i){let a=await u();return await a.collection("link_usage").insertOne({proxy_id:e,session_id:t,user_ip:n,user_fingerprint:r,participant_number:i,status:"waiting",group_session_id:null,joined_at:new Date,redirected_at:null,used_at:new Date})}async function v(e){let t=await u();return await t.collection("link_usage").find({proxy_id:e,status:"waiting"}).sort({joined_at:1}).toArray()}async function b(e,t,n,r=null){let i=await u(),a={status:n,..."redirected"===n&&{redirected_at:new Date},...r&&{group_session_id:r}};return await i.collection("link_usage").updateOne({proxy_id:e,user_fingerprint:t},{$set:a})}async function D(e,t){let r=await u(),i=n(6113).randomBytes(16).toString("hex");return await r.collection("link_usage").updateMany({proxy_id:e,user_fingerprint:{$in:t},status:"waiting"},{$set:{group_session_id:i,status:"redirected",redirected_at:new Date}}),await r.collection("proxy_links").updateOne({proxy_id:e},{$set:{status:"used",completed_at:new Date,current_uses:t.length}}),i}async function O(e){let t=await u(),n=await f(e);if(!n)return null;let r=await v(e),i=await t.collection("link_usage").find({proxy_id:e}).toArray(),a=i.filter(e=>"redirected"===e.status),o=i.length,s=o>=n.max_uses,c=a.length>0;return{proxy_id:e,group_name:n.group_name,category:n.category,treatment_title:n.treatment_title,max_uses:n.max_uses,current_waiting:r.length,total_joined:o,is_full:s,has_redirected_group:c,waiting_participants:r.map(e=>({participant_number:e.participant_number,joined_at:e.joined_at,fingerprint:e.user_fingerprint.substring(0,8)+"..."})),redirected_participants:a.map(e=>({participant_number:e.participant_number,redirected_at:e.redirected_at,group_session_id:e.group_session_id})),real_url:n.real_url}}async function S(){let e=await u(),t=await e.collection("proxy_links").find({}).toArray(),n=t.length,r=t.filter(e=>!1!==e.is_active&&"used"!==e.status).length;return{total:n,active:r,participants:t.reduce((e,t)=>e+(t.current_uses||0),0),full:t.filter(e=>(e.current_uses||0)>=(e.max_uses||3)).length,used:t.filter(e=>"used"===e.status).length}}e.exports={connectToDatabase:u,findAdmin:l,findAdminWithPassword:d,getAllAdmins:_,createAdmin:p,getAllProxyLinks:g,getProxyLink:y,getActiveProxyLink:f,createProxyLink:w,updateProxyLinkStatus:m,incrementProxyLinkUsage:x,resetProxyLinkUsage:h,deleteProxyLink:A,checkLinkUsage:P,recordLinkUsage:k,getProxyStats:S,getWaitingParticipants:v,updateParticipantStatus:b,createGroupSession:D,getGroupStatus:O}},4090:(e,t,n)=>{let r=n(6113);e.exports={generateProxyId:function(){return r.randomBytes(8).toString("hex")},isValidUrl:function(e){try{let t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}},sanitizeInput:function(e){return e&&"string"==typeof e?e.trim().replace(/[<>]/g,""):""},logActivity:function(e,t={}){let n=new Date().toISOString();console.log(`[${n}] ${e}:`,t)},generateFingerprint:function(){return r.randomBytes(16).toString("hex")},getClientIP:function(e){return e.headers["x-forwarded-for"]||e.headers["x-real-ip"]||e.connection?.remoteAddress||"unknown"}}},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=6791);module.exports=n})();
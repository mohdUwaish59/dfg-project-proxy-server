"use strict";(()=>{var e={};e.id=273,e.ids=[273],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6791:(e,r,t)=>{t.r(r),t.d(r,{config:()=>w,default:()=>h,routeModule:()=>j});var i={};t.r(i),t.d(i,{default:()=>x});var n=t(1802),o=t(7153),a=t(6249);let{getActiveProxyLink:s,checkLinkUsage:u,recordLinkUsage:p,getWaitingParticipants:l,createGroupSession:d,checkParticipantExpiration:c,getAllParticipants:g,canFormGenderBasedGroup:m}=t(5410),{logActivity:f,getClientIP:y}=t(4090);async function x(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let{id:t}=e.query,{fingerprint:i,gender:n,prolific_pid:o}=e.body,a=o||i||"test_"+Date.now();if(!a)return r.status(400).json({error:"Prolific ID or fingerprint is required"});let x=n?n.toUpperCase():null;if(x&&!["MALE","FEMALE","OTHER"].includes(x))return console.log("⚠️ Invalid gender provided:",n),r.status(400).json({error:"Invalid gender. Must be MALE, FEMALE, or OTHER"});try{let n=await s(t);if(!n)return r.status(404).json({error:"Link not found or inactive",canJoin:!1});let h=n.category||"No Gender";if(("All Male"===h||"All Female"===h)&&!x)return r.status(400).json({error:"This experiment requires gender information. Please provide your gender to continue.",canJoin:!1,requiredGender:"All Male"===h?"MALE":"FEMALE",missingParameter:"gender",groupName:n.group_name,category:h});if("All Male"===h&&"MALE"!==x)return r.status(403).json({error:"This experiment is for male participants only.",canJoin:!1,requiredGender:"MALE"});if("All Female"===h&&"FEMALE"!==x)return r.status(403).json({error:"This experiment is for female participants only.",canJoin:!1,requiredGender:"FEMALE"});if("Mixed"===h&&!x)return r.status(400).json({error:"Gender information is required for mixed gender experiments.",canJoin:!1,missingParameter:"gender",groupName:n.group_name,category:h});let w=await u(t,i);if(w)return console.log("⚠️ User already joined this room:",{fingerprint:i.substring(0,8)+"...",participantNumber:w.participant_number,currentStatus:w.status,prolificPid:w.prolific_pid}),r.status(403).json({error:"You have already joined this waiting room. Please use your original tab/window.",canJoin:!1,errorType:"already_joined",participantNumber:w.participant_number,status:w.status,joinedAt:w.joined_at});let j=(await g(t)).length;if(j>=n.max_uses)return r.status(403).json({error:"This experiment room is full. Maximum capacity reached.",canJoin:!1,errorType:"full"});let A=j+1;await p(t,e.headers["x-vercel-id"]||"unknown",y(e),a,A,x,o),f("Participant joined waiting room",{proxyId:t,participantNumber:A,gender:x,prolific_pid:o,identifier:a.substring(0,15)+"..."});let E=n.group_size||3,M=await m(t,h,E),_=M.canForm,b=null,P=!1;if(_&&M.participants.length>0){let e=M.participants.map(e=>e.user_fingerprint);P=e.includes(a),b=await d(t,e,M.groupType),f("Gender-based group formed - participants redirected",{proxyId:t,groupSessionId:b,category:h,groupType:M.groupType||"standard",participantCount:e.length,groupNumber:(n.groups_formed||0)+1,participantFingerprints:e.map(e=>e.substring(0,8)+"...")})}let v=await c(t,a),T=await l(t);return r.json({canJoin:!0,alreadyJoined:!1,status:P?"redirected":"waiting",participantNumber:A,currentWaiting:T.length,maxParticipants:n.max_uses,groupSize:E,isGroupComplete:P,groupSessionId:P?b:null,redirectUrl:P?n.real_url:null,participantTimerStart:v.timerStart,participantTimeLeft:v.timeLeft,participantTimerExpired:v.expired,category:h,participantGender:x,groupsFormed:(n.groups_formed||0)+(_?1:0)})}catch(e){return console.error("❌ Join waiting room error:",e),f("Join waiting room error",{error:e.message,proxyId:t}),r.status(500).json({error:"Internal server error"})}}let h=(0,a.l)(i,"default"),w=(0,a.l)(i,"config"),j=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/proxy/[id]/join",pathname:"/api/proxy/[id]/join",bundlePath:"",filename:""},userland:i})},4090:(e,r,t)=>{let i=t(6113);e.exports={generateProxyId:function(){return i.randomBytes(8).toString("hex")},isValidUrl:function(e){try{let r=new URL(e);return"http:"===r.protocol||"https:"===r.protocol}catch(e){return!1}},sanitizeInput:function(e){return e&&"string"==typeof e?e.trim().replace(/[<>]/g,""):""},logActivity:function(e,r={}){let t=new Date().toISOString();console.log(`[${t}] ${e}:`,r)},generateFingerprint:function(){return i.randomBytes(16).toString("hex")},getClientIP:function(e){return e.headers["x-forwarded-for"]||e.headers["x-real-ip"]||e.connection?.remoteAddress||"unknown"}}}};var r=require("../../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[869],()=>t(6791));module.exports=i})();
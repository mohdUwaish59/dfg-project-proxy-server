"use strict";(()=>{var e={};e.id=813,e.ids=[813],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},661:e=>{e.exports=require("sqlite3")},6113:e=>{e.exports=require("crypto")},1017:e=>{e.exports=require("path")},1856:(e,r,t)=>{t.r(r),t.d(r,{config:()=>l,default:()=>d,routeModule:()=>p});var i={};t.r(i),t.d(i,{default:()=>c});var n=t(1802),a=t(7153),s=t(6249);let{getDatabase:o}=t(5417),{logActivity:u}=t(6427);async function c(e,r){if("POST"!==e.method)return r.status(405).json({error:"Method not allowed"});let{id:i}=e.query,{fingerprint:n}=e.body;try{try{let{initDatabase:e}=t(5417);await e()}catch(e){console.log("ℹ️ Database already initialized or initialization not needed")}let a=o(),s=await a.get("SELECT * FROM proxy_links WHERE proxy_id = ? AND is_active = ?",[i,!0]);if(!s)return r.status(404).json({error:"Link not found or inactive",canAccess:!1});let c=await a.get("SELECT * FROM link_usage WHERE proxy_id = ? AND user_fingerprint = ?",[i,n]);if(c)return r.json({canAccess:!0,alreadyUsed:!0,redirectUrl:s.real_url,participantNumber:c.participant_number});if(s.current_uses>=s.max_uses)return r.status(403).json({error:"This experiment link has reached its maximum number of participants",canAccess:!1});let d=s.current_uses+1;return await a.run("INSERT INTO link_usage (proxy_id, session_id, user_ip, user_fingerprint, participant_number) VALUES (?, ?, ?, ?, ?)",[i,e.headers["x-vercel-id"]||"unknown",e.ip||"unknown",n,d]),await a.run("UPDATE proxy_links SET current_uses = current_uses + 1 WHERE proxy_id = ?",[i]),u("Proxy link accessed",{proxyId:i,participantNumber:d,fingerprint:n}),r.json({canAccess:!0,alreadyUsed:!1,redirectUrl:s.real_url,participantNumber:d})}catch(e){return console.error("❌ Proxy check error:",e),r.status(500).json({error:"Internal server error"})}}let d=(0,s.l)(i,"default"),l=(0,s.l)(i,"config"),p=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/proxy/[id]/check",pathname:"/api/proxy/[id]/check",bundlePath:"",filename:""},userland:i})}};var r=require("../../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[188],()=>t(1856));module.exports=i})();
"use strict";(()=>{var e={};e.id=679,e.ids=[679],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6249:(e,n)=>{Object.defineProperty(n,"l",{enumerable:!0,get:function(){return function e(n,t){return t in n?n[t]:"then"in n&&"function"==typeof n.then?n.then(n=>e(n,t)):"function"==typeof n&&"default"===t?n:void 0}}})},9389:(e,n,t)=>{t.r(n),t.d(n,{config:()=>g,default:()=>p,routeModule:()=>_});var r={};t.r(r),t.d(r,{default:()=>f});var o=t(1802),i=t(7153),a=t(6249);let{findAdminWithPassword:s}=t(5410),{setAuthCookie:l,clearAuthCookie:u}=t(9800),{logActivity:c,getClientIP:d}=t(4090);async function f(e,n){if("POST"!==e.method)return n.status(405).json({error:"Method not allowed"});console.log("\uD83D\uDD0D Admin login attempt started"),console.log("\uD83D\uDD0D Request body:",{username:e.body.username,password:"***"});let{username:t,password:r}=e.body;if(!t||!r)return console.log("❌ Missing username or password"),c("Admin login failed",{username:t||"missing",reason:"missing_credentials",ip:e.ip}),u(n),n.status(400).json({error:"Username and password are required"});try{if(console.log("\uD83D\uDD0D Checking user credentials..."),!await s(t,r))return console.log("❌ Invalid credentials for user:",t),c("Admin login failed",{username:t,reason:"invalid_credentials",ip:d(e)}),u(n),n.status(401).json({error:"Invalid username or password"});return console.log("\uD83D\uDD0D Setting JWT authentication..."),l(n,{username:t,adminLoggedIn:!0}),c("Admin login successful",{username:t}),console.log("✅ Login successful, JWT cookie set"),n.json({success:!0,user:{username:t}})}catch(e){return console.error("❌ Login error:",e),c("Admin login error",{error:e.message,username:t}),n.status(500).json({error:"Login failed",details:e.message})}}let p=(0,a.l)(r,"default"),g=(0,a.l)(r,"config"),_=new o.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/login",pathname:"/api/admin/login",bundlePath:"",filename:""},userland:r})},9800:(e,n,t)=>{let r=t(6113),o=process.env.SESSION_SECRET||"your-secret-key-change-this";function i(e){let n=Date.now(),t={...e,iat:n,exp:n+864e5},i=Buffer.from(JSON.stringify({alg:"HS256",typ:"JWT"})).toString("base64url"),a=Buffer.from(JSON.stringify(t)).toString("base64url"),s=r.createHmac("sha256",o).update(`${i}.${a}`).digest("base64url");return`${i}.${a}.${s}`}function a(e){try{if(!e)return null;let[n,t,i]=e.split("."),a=r.createHmac("sha256",o).update(`${n}.${t}`).digest("base64url");if(i!==a)return console.log("❌ JWT signature verification failed"),null;let s=JSON.parse(Buffer.from(t,"base64url").toString());if(s.exp<Date.now())return console.log("❌ JWT token expired"),null;return console.log("✅ JWT token verified:",s),s}catch(e){return console.error("❌ JWT verification error:",e),null}}function s(e){let n=e.headers.cookie;if(n){let e=n.match(/auth-token=([^;]+)/);if(e)return e[1]}return null}e.exports={createToken:i,verifyToken:a,setAuthCookie:function(e,n){console.log("\uD83D\uDD0D Setting auth cookie for user:",n.username);let t=i(n);e.setHeader("Set-Cookie",[`auth-token=${t}; HttpOnly; Path=/; Max-Age=86400; SameSite=Lax`]),console.log("✅ Auth cookie set for user:",n.username)},clearAuthCookie:function(e){e.setHeader("Set-Cookie",["auth-token=; HttpOnly; Path=/; Max-Age=0; SameSite=Lax"]),console.log("✅ Auth cookie cleared")},getTokenFromRequest:s,requireAuth:function(e){let n=a(s(e));return n?(console.log("✅ User authenticated:",n.username),n):(console.log("❌ Authentication required"),null)}}},5410:(e,n,t)=>{let{MongoClient:r,ServerApiVersion:o}=t(8013),i=null,a=null,s=!1;async function l(){if(s&&a)return a;if(!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is required");try{return console.log("\uD83D\uDD0D Connecting to MongoDB..."),i=new r(process.env.DATABASE_URL,{serverApi:{version:o.v1,strict:!0,deprecationErrors:!0}}),await i.connect(),a=i.db("otree_proxy"),s=!0,await i.db("admin").command({ping:1}),console.log("✅ MongoDB connected successfully"),await u(),a}catch(e){throw console.error("❌ MongoDB connection failed:",e),e}}async function u(){try{await a.collection("admins").createIndex({username:1},{unique:!0}),await a.collection("proxy_links").createIndex({proxy_id:1},{unique:!0}),await a.collection("link_usage").createIndex({proxy_id:1,user_fingerprint:1},{unique:!0}),console.log("✅ MongoDB indexes created")}catch(e){console.log("ℹ️ MongoDB indexes may already exist:",e.message)}}async function c(e){let n=await l();return await n.collection("admins").findOne({username:e})}async function d(e,n){let t=await l();return await t.collection("admins").findOne({username:e,password:n})}async function f(){let e=await l();return await e.collection("admins").find({}).toArray()}async function p(e,n){let t=await l();return await t.collection("admins").insertOne({username:e,password:n,created_at:new Date})}async function g(){let e=await l();return(await e.collection("proxy_links").find({}).sort({created_at:-1}).toArray()).map((e,n)=>({id:e._id?e._id.toString():n+1,proxy_id:e.proxy_id,real_url:e.real_url,group_name:e.group_name,max_uses:e.max_uses||3,current_uses:e.current_uses||0,is_active:!1!==e.is_active,created_at:e.created_at instanceof Date?e.created_at.toISOString():e.created_at||new Date().toISOString(),created_by:e.created_by||"admin"}))}async function _(e){let n=await l();return await n.collection("proxy_links").findOne({proxy_id:e})}async function y(e){let n=await l();return await n.collection("proxy_links").findOne({proxy_id:e,is_active:{$ne:!1}})}async function m(e,n,t,r=3){let o=await l();return await o.collection("proxy_links").insertOne({proxy_id:e,real_url:n,group_name:t,max_uses:r,current_uses:0,is_active:!0,created_at:new Date,created_by:"admin"})}async function x(e,n){let t=await l();return await t.collection("proxy_links").updateOne({proxy_id:e},{$set:{is_active:n}})}async function w(e){let n=await l();return await n.collection("proxy_links").updateOne({proxy_id:e},{$inc:{current_uses:1}})}async function D(e){let n=await l();return await n.collection("proxy_links").updateOne({proxy_id:e},{$set:{current_uses:0}}),await n.collection("link_usage").deleteMany({proxy_id:e})}async function h(e){let n=await l();return await n.collection("link_usage").deleteMany({proxy_id:e}),await n.collection("proxy_links").deleteOne({proxy_id:e})}async function A(e,n){let t=await l();return await t.collection("link_usage").findOne({proxy_id:e,user_fingerprint:n})}async function S(e,n,t,r,o){let i=await l();return await i.collection("link_usage").insertOne({proxy_id:e,session_id:n,user_ip:t,user_fingerprint:r,participant_number:o,used_at:new Date})}async function k(){let e=await l(),n=await e.collection("proxy_links").find({}).toArray(),t=n.length;return{total:t,active:n.filter(e=>!1!==e.is_active).length,participants:n.reduce((e,n)=>e+(n.current_uses||0),0),full:n.filter(e=>(e.current_uses||0)>=(e.max_uses||3)).length}}e.exports={connectToDatabase:l,findAdmin:c,findAdminWithPassword:d,getAllAdmins:f,createAdmin:p,getAllProxyLinks:g,getProxyLink:_,getActiveProxyLink:y,createProxyLink:m,updateProxyLinkStatus:x,incrementProxyLinkUsage:w,resetProxyLinkUsage:D,deleteProxyLink:h,checkLinkUsage:A,recordLinkUsage:S,getProxyStats:k}},4090:(e,n,t)=>{let r=t(6113);e.exports={generateProxyId:function(){return r.randomBytes(8).toString("hex")},isValidUrl:function(e){try{let n=new URL(e);return"http:"===n.protocol||"https:"===n.protocol}catch(e){return!1}},sanitizeInput:function(e){return e&&"string"==typeof e?e.trim().replace(/[<>]/g,""):""},logActivity:function(e,n={}){let t=new Date().toISOString();console.log(`[${t}] ${e}:`,n)},generateFingerprint:function(){return r.randomBytes(16).toString("hex")},getClientIP:function(e){return e.headers["x-forwarded-for"]||e.headers["x-real-ip"]||e.connection?.remoteAddress||"unknown"}}},7153:(e,n)=>{var t;Object.defineProperty(n,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,n,t)=>{e.exports=t(145)}};var n=require("../../../webpack-api-runtime.js");n.C(e);var t=n(n.s=9389);module.exports=t})();
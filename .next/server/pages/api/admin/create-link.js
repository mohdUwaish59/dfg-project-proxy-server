"use strict";(()=>{var e={};e.id=864,e.ids=[864],e.modules={8013:e=>{e.exports=require("mongodb")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},5173:(e,t,n)=>{n.r(t),n.d(t,{config:()=>y,default:()=>_,routeModule:()=>g});var r={};n.r(r),n.d(r,{default:()=>p});var i=n(1802),o=n(7153),a=n(6249);let{createProxyLink:c}=n(5410),{requireAuth:u}=n(9800),{generateProxyId:l,isValidUrl:s,sanitizeInput:d,logActivity:f}=n(4090);async function p(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});let n=u(e);if(!n)return t.status(401).json({error:"Unauthorized - Admin login required"});let{realUrl:r,groupName:i}=e.body;if(!s(r))return t.status(400).json({error:"Invalid URL format"});try{let e=d(i),o=l();await c(o,r,e||null,3),f("Link created",{proxyId:o,groupName:e,admin:n.username}),t.json({success:!0,proxyId:o})}catch(e){return f("Create link error",{error:e.message,groupName:sanitizedGroupName}),t.status(500).json({error:"Database error: "+e.message})}}let _=(0,a.l)(r,"default"),y=(0,a.l)(r,"config"),g=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/admin/create-link",pathname:"/api/admin/create-link",bundlePath:"",filename:""},userland:r})},9800:(e,t,n)=>{let r=n(6113),i=process.env.SESSION_SECRET||"your-secret-key-change-this";function o(e){let t=Date.now(),n={...e,iat:t,exp:t+864e5},o=Buffer.from(JSON.stringify({alg:"HS256",typ:"JWT"})).toString("base64url"),a=Buffer.from(JSON.stringify(n)).toString("base64url"),c=r.createHmac("sha256",i).update(`${o}.${a}`).digest("base64url");return`${o}.${a}.${c}`}function a(e){try{if(!e)return null;let[t,n,o]=e.split("."),a=r.createHmac("sha256",i).update(`${t}.${n}`).digest("base64url");if(o!==a)return console.log("❌ JWT signature verification failed"),null;let c=JSON.parse(Buffer.from(n,"base64url").toString());if(c.exp<Date.now())return console.log("❌ JWT token expired"),null;return console.log("✅ JWT token verified:",c),c}catch(e){return console.error("❌ JWT verification error:",e),null}}function c(e){let t=e.headers.cookie;if(t){let e=t.match(/auth-token=([^;]+)/);if(e)return e[1]}return null}e.exports={createToken:o,verifyToken:a,setAuthCookie:function(e,t){console.log("\uD83D\uDD0D Setting auth cookie for user:",t.username);let n=o(t);e.setHeader("Set-Cookie",[`auth-token=${n}; HttpOnly; Path=/; Max-Age=86400; SameSite=Lax`]),console.log("✅ Auth cookie set for user:",t.username)},clearAuthCookie:function(e){e.setHeader("Set-Cookie",["auth-token=; HttpOnly; Path=/; Max-Age=0; SameSite=Lax"]),console.log("✅ Auth cookie cleared")},getTokenFromRequest:c,requireAuth:function(e){let t=a(c(e));return t?(console.log("✅ User authenticated:",t.username),t):(console.log("❌ Authentication required"),null)}}},5410:(e,t,n)=>{let{MongoClient:r,ServerApiVersion:i}=n(8013),o=null,a=null,c=!1;async function u(){if(c&&a)return a;if(!process.env.DATABASE_URL)throw Error("DATABASE_URL environment variable is required");try{return console.log("\uD83D\uDD0D Connecting to MongoDB..."),o=new r(process.env.DATABASE_URL,{serverApi:{version:i.v1,strict:!0,deprecationErrors:!0}}),await o.connect(),a=o.db("otree_proxy"),c=!0,await o.db("admin").command({ping:1}),console.log("✅ MongoDB connected successfully"),await l(),a}catch(e){throw console.error("❌ MongoDB connection failed:",e),e}}async function l(){try{await a.collection("admins").createIndex({username:1},{unique:!0}),await a.collection("proxy_links").createIndex({proxy_id:1},{unique:!0}),await a.collection("link_usage").createIndex({proxy_id:1,user_fingerprint:1},{unique:!0}),console.log("✅ MongoDB indexes created")}catch(e){console.log("ℹ️ MongoDB indexes may already exist:",e.message)}}async function s(e){let t=await u();return await t.collection("admins").findOne({username:e})}async function d(e,t){let n=await u();return await n.collection("admins").findOne({username:e,password:t})}async function f(){let e=await u();return await e.collection("admins").find({}).toArray()}async function p(e,t){let n=await u();return await n.collection("admins").insertOne({username:e,password:t,created_at:new Date})}async function _(){let e=await u();return(await e.collection("proxy_links").find({}).sort({created_at:-1}).toArray()).map((e,t)=>({id:e._id?e._id.toString():t+1,proxy_id:e.proxy_id,real_url:e.real_url,group_name:e.group_name,max_uses:e.max_uses||3,current_uses:e.current_uses||0,is_active:!1!==e.is_active,created_at:e.created_at instanceof Date?e.created_at.toISOString():e.created_at||new Date().toISOString(),created_by:e.created_by||"admin"}))}async function y(e){let t=await u();return await t.collection("proxy_links").findOne({proxy_id:e})}async function g(e){let t=await u();return await t.collection("proxy_links").findOne({proxy_id:e,is_active:{$ne:!1}})}async function m(e,t,n,r=3){let i=await u();return await i.collection("proxy_links").insertOne({proxy_id:e,real_url:t,group_name:n,max_uses:r,current_uses:0,is_active:!0,created_at:new Date,created_by:"admin"})}async function x(e,t){let n=await u();return await n.collection("proxy_links").updateOne({proxy_id:e},{$set:{is_active:t}})}async function w(e){let t=await u();return await t.collection("proxy_links").updateOne({proxy_id:e},{$inc:{current_uses:1}})}async function h(e){let t=await u();return await t.collection("proxy_links").updateOne({proxy_id:e},{$set:{current_uses:0}}),await t.collection("link_usage").deleteMany({proxy_id:e})}async function A(e){let t=await u();return await t.collection("link_usage").deleteMany({proxy_id:e}),await t.collection("proxy_links").deleteOne({proxy_id:e})}async function k(e,t){let n=await u();return await n.collection("link_usage").findOne({proxy_id:e,user_fingerprint:t})}async function S(e,t,n,r,i){let o=await u();return await o.collection("link_usage").insertOne({proxy_id:e,session_id:t,user_ip:n,user_fingerprint:r,participant_number:i,used_at:new Date})}async function v(){let e=await u(),t=await e.collection("proxy_links").find({}).toArray(),n=t.length;return{total:n,active:t.filter(e=>!1!==e.is_active).length,participants:t.reduce((e,t)=>e+(t.current_uses||0),0),full:t.filter(e=>(e.current_uses||0)>=(e.max_uses||3)).length}}e.exports={connectToDatabase:u,findAdmin:s,findAdminWithPassword:d,getAllAdmins:f,createAdmin:p,getAllProxyLinks:_,getProxyLink:y,getActiveProxyLink:g,createProxyLink:m,updateProxyLinkStatus:x,incrementProxyLinkUsage:w,resetProxyLinkUsage:h,deleteProxyLink:A,checkLinkUsage:k,recordLinkUsage:S,getProxyStats:v}},4090:(e,t,n)=>{let r=n(6113);e.exports={generateProxyId:function(){return r.randomBytes(8).toString("hex")},isValidUrl:function(e){try{let t=new URL(e);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}},sanitizeInput:function(e){return e&&"string"==typeof e?e.trim().replace(/[<>]/g,""):""},logActivity:function(e,t={}){let n=new Date().toISOString();console.log(`[${n}] ${e}:`,t)},generateFingerprint:function(){return r.randomBytes(16).toString("hex")},getClientIP:function(e){return e.headers["x-forwarded-for"]||e.headers["x-real-ip"]||e.connection?.remoteAddress||"unknown"}}},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=5173);module.exports=n})();